<script>
  // SpotCam 在 App Store 的正式連結
  var appStoreUrl = "https://apps.apple.com/tw/app/spotcam/id908179081";
  var deviceId = "12345";

  var hasVisibilityChanged = false;

  function log(msg) {
    var el = document.getElementById("log");
    if (el) {
      el.textContent += msg + "\n";
    }
  }

  // 偵測使用者是否離開這個頁面（例如被切到 App）
  document.addEventListener("visibilitychange", function () {
    if (document.hidden) {
      hasVisibilityChanged = true;
      log("頁面變為隱藏，可能已切換到 App。");
    } else {
      log("頁面重新可見。");
    }
  });

  function openApp() {
    log("開始嘗試開啟 App...");

    var appUrl = "SpotCam://device?id=" + encodeURIComponent(deviceId);
    log("App URL: " + appUrl);

    // 重置狀態
    hasVisibilityChanged = false;

    // 嘗試打開 App
    window.location.href = appUrl;

    // 設定 fallback：只有在「還停在瀏覽器」時才跳 App Store
    setTimeout(function () {
      if (!hasVisibilityChanged) {
        log("仍然停留在網頁，準備前往 App Store。");
        window.location.href = appStoreUrl;
      } else {
        log("偵測到已離開頁面，不跳 App Store。");
      }
    }, 1500);
  }
</script>
